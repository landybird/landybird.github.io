---
title: Redis 性能问题
description: `Redis` 性能指标
categories:
- redis
tags:
- redis
---

------


## 1 `Info 命令`

`redis`使用`info`命令获取所有与Redis服务相关的各种信息和统计数值 

        server   查看 Redis 服务器信息，如 Redis 的版本
        clients  客户端的连接部分
        memory   内存消耗相关信息       #
        persistence  RDB和AOF相关信息
        stats      一般统计           #
        replication   主/从复制信息
        cpu     统计CPU的消耗
        commandstats   Redis命令统计  #
        cluster    Redis集群信息
        keyspace   数据库的相关统计


```
    dbsize： 查看当前db的key数量
```


### 1) `info memory` 只返回与内存相关的数据


    
<table><thead><tr><th style="text-align:left"><div><div class="table-header"><p>指标</p></div></div></th><th style="text-align:left"><div><div class="table-header"><p>含义</p></div></div></th></tr></thead><tbody><tr><td style="text-align:left"><div><div class="table-cell"><p><b>used_memory</b></p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>由 Redis 分配器分配的内存总量，包含了redis进程内部的开销和数据占用的内存，以字节（byte）为单位，即<b>当前redis使用内存大小</b>。</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_human</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>已更直观的单位展示分配的内存总量。</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p><b>used_memory_rss</b></p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p><b>向操作系统申请的内存大小</b>，与 top 、 ps等命令的输出一致，即redis使用的<b>物理内存</b>大小。</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_rss_human</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>已更直观的单位展示向操作系统申请的内存大小。</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_peak</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>redis的内存消耗峰值(以字节为单位)，即历史使用记录中redis使用内存峰值。</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_peak_human</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>以更直观的格式返回redis的内存消耗峰值</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_peak_perc</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>使用内存达到峰值内存的百分比，used_memory/ used_memory_peak) *100%，即当前redis使用内存/历史使用记录中redis使用内存峰值*100%</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_overhead</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>Redis为了维护数据集的内部机制所需的内存开销，包括所有客户端输出缓冲区、查询缓冲区、AOF重写缓冲区和主从复制的backlog。</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_startup</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>Redis服务器启动时消耗的内存</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_dataset</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>数据实际占用的内存大小，即used_memory-used_memory_overhead</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_dataset_perc</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>数据占用的内存大小的百分比，100%*(used_memory_dataset/(used_memory-used_memory_startup))</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>total_system_memory</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>整个系统内存</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>total_system_memory_human</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>以更直观的格式显示整个系统内存</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_lua</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>Lua脚本存储占用的内存</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>used_memory_lua_human</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>以更直观的格式显示Lua脚本存储占用的内存</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>maxmemory</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>Redis实例的最大内存配置</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>maxmemory_human</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>以更直观的格式显示Redis实例的最大内存配置</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>maxmemory_policy</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>当达到maxmemory时的淘汰策略</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p><b>mem_fragmentation_ratio</b></p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p><b>碎片率</b>，used_memory_rss/ used_memory。ratio指数&gt;1表明有内存碎片，越大表明越多，&lt;1表明正在使用虚拟内存，虚拟内存其实就是硬盘，性能比内存低得多，这是应该增强机器的内存以提高性能。<b>一般来说，mem_fragmentation_ratio的数值在1 ~ 1.5之间是比较健康的</b>。详解</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>mem_allocator</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>内存分配器</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>active_defrag_running</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>表示没有活动的defrag任务正在运行，1表示有活动的defrag任务正在运行（defrag:表示内存碎片整理）详解</p></div></div></td></tr><tr><td style="text-align:left"><div><div class="table-cell"><p>lazyfree_pending_objects</p></div></div></td><td style="text-align:left"><div><div class="table-cell"><p>0表示不存在延迟释放的挂起对象</p></div></div></td></tr></tbody></table>



### 2) `info stats` 一般统计信息

|指标|含义|
|---|---|
|total_connections_received|服务器接受的连接总数|
|total_commands_processed|服务器处理的命令总数|
|instantaneous_ops_per_sec|每秒处理的命令数|
|rejected_connections|由于maxclients限制而拒绝的连接数|
|expired_keys|key到期事件的总数|
|evicted_keys|由于maxmemory最大内存限制而导致被驱逐的key的数量|
|keyspace_hits|key命中次数|
|keyspace_misses|key未命中次数|


### 3) `info clients` 已连接客户端信息

|指标|含义|
|---|---|
|connected_clients|已连接客户端的数量（不包括通过从属服务器连接的客户端|
|client_longest_output_list|当前连接的客户端当中，最长的输出列表|
|client_biggest_input_buf|当前连接的客户端当中，最大输入缓存|
|blocked_clients|正在等待阻塞命令（BLPOP、BRPOP、BRPOPLPUSH）的客户端的数量|

### 4) `info cpu` 统计CPU的消耗

|指标|含义|
|---|---|
|used_cpu_sys|消耗的系统CPU|
|used_cpu_user|消耗的用户CPU|
|used_cpu_sys_children|后台进程占用的系统CPU|
|used_cpu_user_children|后台进程占用的用户CPU|

### 5) `info commandstats` Redis命令统计

提供基于命令类型的统计信息，包括调用次数，这些命令消耗的总CPU时间以及每个命令执行消耗的平均CPU时间

对于每一个命令类型，添加以下行：
    
        cmdstat_XXX: calls=XXX,usec=XXX,usec_per_call=XXX
    
        calls 次数
        usec 时间
        usec_per_call 平均时间


## 2 `memory 命令`

获得有关服务器内存的其他内省信息，可以参考`MEMORY STATS`和`MEMORY DOCTOR`




|指标|含义|
|---|---|
|MEMORY DOCTOR|列出 Redis 服务器遇到的内存相关问题，并提供相应的解决建议|
|MEMORY MALLOC-STATS|提供内存分配情况的内部统计报|
|MEMORY PURGE|尝试清除脏页以便内存分配器回收使用|
|MEMORY USAGE key|给出一个 key 和它的值在 RAM 中所占用的字节数|
|`MEMORY STATS`|将服务器的内存使用情况以数组情况返回|

        jemalloc作为内存分配器


### 1) `MEMORY STATS` 命令将服务器的内存使用情况以数组情况返回

|指标|含义|
|---|---|
|peak.allocated|redis启动以来，allocator分配的内存峰值，单位字节；同INFO的`used_memory_peak`|
|total.allocated|allocator 当前分配的内存总字节数；同 INFO命令`used_memeory`|
|startup.allocated|Redis启动完成消耗的内存字节数；同INFO的`used_memory_startup`|
|clients.normal|Redis所有常规客户端内存消耗总字节数(查询输出缓冲区，连接内存消耗)|
|overhead.total|Redis 额外内存消耗总字节数，i.e. startup.allocated, replication.backlog, clients.slaves, clients.normal, aof.buffer 以及管理keyspace使用的内部数据接口消耗的内存字节数 同INFO的`used_memory_overhead`|
|keys.count|整个redis实例key的个数|
|keys.bytes-per-key|每个key平均字节数，net memory usage(total.allocated 减去 startup.allocated)与keys.count的比值|
|dataset.bytes|Redis 实例中数据占用的总字节数，计算方法total.allocated减去overhead.total|
|dataset.percentage|Redis 数据消耗内存占总内存的百分比|
|peak.percentage|当前内存消耗占峰值内存消耗的百分比|


```flow
st=>start: Start
op=>operation: Your Operation
cond=>condition: Yes or No?
e=>end


st->op->cond
cond(yes)->e
cond(no)->op
```
